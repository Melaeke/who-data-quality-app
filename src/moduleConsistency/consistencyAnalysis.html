<h4 style="margin-top: 20px;">Consistency</h4>

<!-- PARAMETERS -->
<accordion close-others="aCtrl.oneAtATime">
	
	<!-- OPTIONS -->
	<accordion-group heading="Analysis Type" is-open="aCtrl.status.isFirstOpen">
		<label>Consistency analysis type</label><br />
		<div class="btn-group btn-group-justified" style="width: 330px; margin-bottom: 10px;">
				<label class="btn btn-default" ng-model="aCtrl.consistencyType" btn-radio="'relation'">Between Indicators</label>
		  		<label class="btn btn-default" ng-model="aCtrl.consistencyType" btn-radio="'time'">Over Time</label>
		</div>
		
		<div ng-if="aCtrl.consistencyType === 'relation'">		
		<label>Expected relationship</label><br />
		<div class="btn-group btn-group-justified" style="width: 330px; margin-bottom: 10px;">
				<label class="btn btn-default" ng-model="aCtrl.relationshipType" btn-radio="'level'">None</label>
				<label class="btn btn-default" ng-model="aCtrl.relationshipType" btn-radio="'eq'">A ≈ B</label>
		  		<label class="btn btn-default" ng-model="aCtrl.relationshipType" btn-radio="'aGTb'">A > B</label>
		  		<label class="btn btn-default" ng-model="aCtrl.relationshipType" btn-radio="'do'">Dropout</label>
		</div>
		</div>
		
		<div ng-if="aCtrl.consistencyType === 'time'">		
		<label>Expected trend</label><br />
		<div class="btn-group btn-group-justified" style="width: 330px; margin-bottom: 10px;">
				<label class="btn btn-default" ng-model="aCtrl.trendType" btn-radio="'constant'">Constant</label>
		  		<label class="btn btn-default" ng-model="aCtrl.trendType" btn-radio="'increase'">Increasing/decreasing</label>
		</div>
		</div>
		
		<div style="margin-bottom: 10px;" ng-if="aCtrl.relationshipType != 'do' || aCtrl.consistencyType === 'time'">		
		<label>Criteria</label><br />
		<input class="form-control" type="number" style="text-align: right; width: 150px; display: inline-block;" ng-model="aCtrl.consistencyCriteria" min="0" max="50"> <span style="display: inline-block;">%</span>
		</div>
	</accordion-group>	


	<!-- DATA -->
    <accordion-group heading="Data">

		<div ng-repeat="code in ['a', 'b']" ng-show="!(code === 'b' && aCtrl.consistencyType === 'time')">
			<h4 ng-if="aCtrl.consistencyType === 'relation'">Indicator/Data element {{code}}</h4>
			<div class="btn-group btn-group-justified" ng-click="alert(123);" style="max-width: 470px; margin-bottom: 10px;">
				<label class="btn btn-default" ng-model="aCtrl.dataSelection[code].type" btn-radio="'de'">Data element (totals)</label>
				<label class="btn btn-default" ng-model="aCtrl.dataSelection[code].type" btn-radio="'dc'">Data element (details)</label>
				<label class="btn btn-default" ng-model="aCtrl.dataSelection[code].type" btn-radio="'ind'">Indicator</label>
			</div>

			<ui-select
				on-select="aCtrl.updateItemList(code); aCtrl.dataSelection[code].item = null;"
				ng-model="aCtrl.dataSelection[code].group"
				style="margin-bottom: 10px; max-width: 470px;">
				<ui-select-match allow-clear="true" placeholder="Select group...">
					{{aCtrl.dataSelection[code].group.name}}
				</ui-select-match>
				<ui-select-choices
					repeat="obj in aCtrl.getGroupForCode(code)| filter: $select.search">
					<div ng-bind-html="obj.name | highlight: $select.search"></div>
				</ui-select-choices>
			</ui-select>

			<ui-select
				ng-disabled="!aCtrl.dataSelection[code].group || aCtrl.dataSelection[code].items.length < 1"
				ng-model="aCtrl.dataSelection[code].item"
				on-select="aCtrl.updatePeriodList(code)"
				style="margin-bottom: 10px; max-width: 470px;">
				<ui-select-match allow-clear="true" placeholder="{{aCtrl.dataSelection[code].itemDescription}}">
					{{aCtrl.dataSelection[code].item.name}}
				</ui-select-match>
				<ui-select-choices
					repeat="obj in aCtrl.dataSelection[code].items | filter: $select.search">
					<div ng-bind-html="obj.name | highlight: $select.search"></div>
				</ui-select-choices>
			</ui-select>
			</div>

    </accordion-group>
    
    
    <!-- PERIOD -->
    <accordion-group heading="Period">
    	
    	<h4 ng-if="aCtrl.consistencyType === 'time'">Period</h4>
    	<div style="display: inline-block;">
    		<label>Period type</label><br />
    		<div style="display: inline-block;">
    		<ui-select on-select="aCtrl.getPeriodsInYear(); aCtrl.periodSelected = null;" ng-model="aCtrl.periodTypeSelected"  style="margin-bottom: 10px; width: 200px;">
    		  <ui-select-match placeholder="Select period type...">
    		  	{{aCtrl.periodTypeSelected.name}}
    		  </ui-select-match>
    		  <ui-select-choices 
    		  	repeat="obj in aCtrl.filteredPeriodTypes | filter: $select.search">
    		   		<div ng-bind-html="obj.name | highlight: $select.search"></div>
    		  </ui-select-choices>
    		</ui-select>
    		</div>
    	</div>
    	
    	<div style="display: inline-block;">
    		<label>Year</label><br />
    		<div style="display: inline-block;">
    		<ui-select on-select="aCtrl.getPeriodsInYear(); aCtrl.periodSelected = null;" ng-model="aCtrl.yearSelected"  style="margin-bottom: 10px; width: 200px;">
    		  <ui-select-match placeholder="Select year...">
    		  	{{aCtrl.yearSelected.name}}
    		  </ui-select-match>
    		  <ui-select-choices 
    		  	repeat="obj in aCtrl.years | filter: $select.search">
    		   		<div ng-bind-html="obj.name | highlight: $select.search"></div>
    		  </ui-select-choices>
    		</ui-select>
    		</div>
    	
    	</div>
    	
    	<div ng-if="aCtrl.periodTypeSelected.id != 'Yearly'" style="display: inline-block;">
    		<label>Period</label><br />
    		<div style="display: inline-block;">
    		<ui-select ng-model="aCtrl.periodSelected"  style="margin-bottom: 10px; width: 200px;">
    		  <ui-select-match placeholder="Select period...">
    		  	{{aCtrl.periodSelected.name}}
    		  </ui-select-match>
    		  <ui-select-choices 
    		  	repeat="obj in aCtrl.periodsInYear | filter: $select.search">
    		   		<div ng-bind-html="obj.name | highlight: $select.search"></div>
    		  </ui-select-choices>
    		</ui-select>
    		</div>
    	
    	</div>
    	
    	<div ng-if="aCtrl.consistencyType === 'time'">
    		
    			<h4>Reference periods</h4>
    		<label>No. of Preceding periods</label><br />
    		<div style="display: inline-block;">
    			<ui-select ng-model="aCtrl.periodCountSelected"  style="margin-bottom: 10px; width: 200px;">
    			  <ui-select-match placeholder="Select number of periods...">
    			  	{{aCtrl.periodCountSelected.name}}
    			  </ui-select-match>
    			  <ui-select-choices 
    			  	repeat="obj in aCtrl.periodCounts | filter: $select.search">
    			   		<div ng-bind-html="obj.name | highlight: $select.search"></div>
    			  </ui-select-choices>
    			</ui-select>
    		</div>    	
    	</div>
    	
    </accordion-group>
    
    <!-- ORGUNIT -->
    <accordion-group heading="Orgunit" is-open="status.open">
    	<label>Boundary</label><br />
    	<div class="btn-group btn-group-justified" style="max-width: 400px;">
    	  	<label ng-repeat="orgunit in aCtrl.userOrgunits track by $index" class="btn btn-default" ng-model="aCtrl.boundarySelectionType" ng-change="aCtrl.orgunitUserModeSelected();" btn-radio="$index">{{orgunit.name}}</label>
    	  	<label class="btn btn-default" ng-model="aCtrl.boundarySelectionType" btn-radio="aCtrl.userOrgunits.length">All</label>
    	</div>
		<br />	  
		<div ng-show="aCtrl.userOrgunits.length === aCtrl.boundarySelectionType" style="margin-bottom: 10px;">
			<div style="width:400px; height: 400px; overflow: scroll; border:1px solid lightgray; border-radius:5px;">
				<abn-tree
						tree-data="aCtrl.ouTreeData"
						tree-control="aCtrl.ouTreeControl"
						on-select="aCtrl.ouTreeSelect(branch)">
				</abn-tree>
			</div>
		</div>  		    	
		
	<!-- DISAGGREGATION -->
       <label for="orgunitSelect">Disaggregation</label>
		<div id="orgunitSelect">
			<ui-select ng-disabled="aCtrl.orgunitGroupSelected || aCtrl.filteredOrgunitLevels.length === 0" ng-model="aCtrl.orgunitLevelSelected"  style="margin-bottom: 10px; max-width: 400px;">
			  <ui-select-match allow-clear="true" placeholder="{{aCtrl.getLevelPlaceholder();}}">
			  	{{aCtrl.orgunitLevelSelected.name}}
			  </ui-select-match>
			  <ui-select-choices 
			  	repeat="obj in aCtrl.filteredOrgunitLevels | filter: $select.search">
			   		<div ng-bind-html="obj.name | highlight: $select.search"></div>
			  </ui-select-choices>
			</ui-select>
			
			<ui-select ng-disabled="aCtrl.orgunitLevelSelected || aCtrl.filteredOrgunitLevels.length === 0" ng-model="aCtrl.orgunitGroupSelected"  style="margin-bottom: 10px; max-width: 400px;">
				  <ui-select-match allow-clear="true" placeholder="Select organisation unit group">
				  	{{aCtrl.orgunitGroupSelected.name}}
				  </ui-select-match>
				  <ui-select-choices 
				  	repeat="obj in aCtrl.orgunitGroups | filter: $select.search">
				   		<div ng-bind-html="obj.name | highlight: $select.search"></div>
				  </ui-select-choices>
			</ui-select>
		</div>
		
		
		<!-- CURRENT SELECTION -->
		<label for="orgunitSelected">Selected </label>
		<div id="orgunitSelected">
			<p>
				<span style="font-size: 100%;" class="label label-primary">{{aCtrl.boundaryOrgunitSelected.name}}</span>
				<span ng-if="aCtrl.orgunitLevelSelected"><span class="glyphicon glyphicon-chevron-right"></span><span style="font-size: 100%;" class="label label-primary">{{aCtrl.orgunitLevelSelected.name}}</span></span>
				<span ng-if="aCtrl.orgunitGroupSelected"><span class="glyphicon glyphicon-chevron-right"></span><span style="font-size: 100%;" class="label label-primary">{{aCtrl.orgunitGroupSelected.name}}</span></span>
			</p>
			<br />
		</div>
		<label>NOTE</label>
		<p>Consistency analysis is always done for multiple organisation units. It is therefore not possible to search for and select individual facilities. To analyse facilities, chose a district or other organisation unit above the facilities, and instead use the disaggregation by level/group (for example the <em>{{aCtrl.filteredOrgunitLevels[aCtrl.filteredOrgunitLevels.length-1].name}}</em>-level).</p>
    </accordion-group>
  </accordion>  	
  
<button type="button" class="btn btn-primary pull-right" ng-click="aCtrl.doAnalysis(null, null);"
	ng-disabled="(!aCtrl.periodSelected && aCtrl.periodTypeSelected.id != 'Yearly') || !aCtrl.dataSelection.a.item ||
		(aCtrl.consistencyType === 'relation' && !aCtrl.dataSelection.b.item)" style="margin-bottom:20px">Analyze</button>

<hr / style="clear: both;">

<div ng-if="aCtrl.req">
<h5>Loading data...</h5>
<progressbar class="progress-striped active" value="100" type="default"><i ng-show="showWarning">Processing</i></progressbar>
</div>

<!-- RESULT -->
<div ng-if="aCtrl.result === undefined" style="height: 400px;"></div>
<div ng-if="aCtrl.result">
	<div class="pull-left">
		<h4>{{aCtrl.title()}}</h4>
	</div>
	<div class="pull-right">
		<div class="btn-group">
			<button type="button" ng-click="aCtrl.exportCSV();" class="btn btn-default" style="width: 100px">
				Download
			</button>
			<button style="width: 100px" type="button" class="btn btn-default"
					ng-disabled="aCtrl.results.length < 2 || aCtrl.currentResult >= 4 || (1 + aCtrl.currentResult) === aCtrl.results.length"
					ng-click="aCtrl.previousResult();">
				Previous
			</button>
		</div>
	</div>

<div style="display: inline-block; width: 100%; margin-top: 10px">
	<nvd3 id="mainChart" style="display: inline-block; width: 55%; vertical-align: top;" options='aCtrl.chart.options' data='aCtrl.chart.data'></nvd3>

	<div style="font-size: 85%; display: inline-block; width: 44%;  vertical-align: top;" class="table-responsive">
	<table class="table table-bordered table-striped table-condensed table-hover">
		<thead>
		    <tr>
		    
		    	<th style="white-space:nowrap;" ng-click="aCtrl.sortByColumn('name')">
					Unit
					<span ng-if="aCtrl.sortCol === 'name'" class="glyphicon glyphicon-sort-by-attributes"></span>
				</th>
		    	<th ng-click="aCtrl.sortByColumn('value')">
		    		<span ng-if="aCtrl.result.consistencyType === 'relation'">
		    			{{aCtrl.result.dxNameA}}
		    		</span>
		    		<span ng-if="aCtrl.result.consistencyType === 'time'">
						Current Period
					</span>
					<span ng-if="aCtrl.sortCol === 'value'" class="glyphicon glyphicon-sort-by-attributes"></span>
		    	</th>
		    	<th ng-click="aCtrl.sortByColumn('refValue')">
			    	<span ng-if="aCtrl.result.consistencyType === 'relation'">{{aCtrl.result.dxNameB}}</span>
			    	<span ng-if="aCtrl.result.consistencyType === 'time' && aCtrl.result.type === 'constant'">Average</span>
			    	<span ng-if="aCtrl.result.consistencyType === 'time' && aCtrl.result.type != 'constant'">Forecast</span>
					<span ng-if="aCtrl.sortCol === 'refValue'" class="glyphicon glyphicon-sort-by-attributes"></span>
		    	</th>
		    	<th style="white-space:nowrap;" ng-click="aCtrl.sortByColumn('ratio')">
			    	<span ng-if="aCtrl.result.consistencyType === 'relation' && aCtrl.result.type === 'do'">Dropout rate (%)</span>
			    	<span ng-if="aCtrl.result.consistencyType === 'relation' && aCtrl.result.type != 'do'">Ratio</span>
			    	<span ng-if="aCtrl.result.consistencyType === 'time'">Ratio</span>
					<span class="glyphicon glyphicon-info-sign"
						  style="color: black"
						  aria-hidden="true"
						  tooltip="{{aCtrl.ratioDescription()}}">
					</span>
					<span ng-if="aCtrl.sortCol === 'ratio'" class="glyphicon glyphicon-sort-by-attributes"></span>
		    	</th>
		    	<th style="white-space:nowrap;" ng-click="aCtrl.sortByColumn('weight')">
					Weight
					<span class="glyphicon glyphicon-info-sign"
						  style="color: black"
						  aria-hidden="true"
						  tooltip="Significance of potential data quality problem.">
					</span>
					<span ng-if="aCtrl.sortCol === 'weight'" class="glyphicon glyphicon-sort-by-attributes"></span>
				</th>
		    </tr>
		</thead>
		
		<tfoot>
		    <td colspan="5">
		        <pagination total-items="aCtrl.totalRows" items-per-page="aCtrl.pageSize" max-size="5" ng-model="aCtrl.currentPage" class="pagination-sm pull-right" boundary-links="true" rotate="true"></pagination>
		    </td>
		</tfoot>
		
		<tbody>
			<tr	class="info"
				valign="middle">
				<td>{{aCtrl.result.boundaryName}}</td>
				<td class="valueCell">{{aCtrl.result.boundaryValue}}</td>
				<td class="valueCell">{{aCtrl.result.boundaryRefValue}}</td>
				<td class="valueCell">
	            	<span ng-if="aCtrl.result.consistencyType === 'relation' && aCtrl.result.type === 'do'">
	            		{{aCtrl.dropoutRate(aCtrl.result.boundaryValue, aCtrl.result.boundaryRefValue)}}%
	            	</span>
	            	<span ng-if="aCtrl.result.type != 'do' && aCtrl.validRatio(aCtrl.result.boundaryRatio)">
	            		{{aCtrl.result.boundaryRatio}}
	            	</span>
				</td>
				<td></td>
			</tr>
	    	<tr 
	    		ng-click="aCtrl.selectOrgunit(row);" 
	    		ng-class="{warning: row.id === aCtrl.selectedObject.id}" 
	    		valign="middle" 
	    		ng-repeat="row in aCtrl.tableData | orderBy:aCtrl.sortCol:aCtrl.reverse | startFrom:(aCtrl.currentPage-1)*aCtrl.pageSize | limitTo:aCtrl.pageSize">
	            <td >{{row.name}}</td>
	            <td class="valueCell">{{row.value}}</td>
	            <td class="valueCell">{{row.refValue}}</td>
	            <td class="valueCell" ng-class="{danger: row.violation}">
	            	<span ng-if="aCtrl.result.consistencyType === 'relation' && aCtrl.result.type === 'do'">
	            		{{aCtrl.dropoutRate(row.value, row.refValue)}}%
	            	</span>
	            	<span ng-if="aCtrl.result.type != 'do' && aCtrl.validRatio(row.ratio)">
	            		{{row.ratio}}
	            	</span>
	            </td>
	            <td>{{row.weight}}</td>
	        </tr>
		</tbody>
	</table>
	</div>
</div>

<div style="margin-bottom: 10px;">
<h4>Selected</h4>
<table class="table table-bordered table-striped table-condensed table-hover">
	<thead>
	    <tr>	
	    	<th nowrap>Unit</th>
	    	<th>
	    		<span ng-if="aCtrl.result.consistencyType === 'relation'">{{aCtrl.result.dxNameA}}</span>
	    		<span ng-if="aCtrl.result.consistencyType === 'time'">Current Period</span></th>
	    	<th>
	    		<span ng-if="aCtrl.result.consistencyType === 'relation'">{{aCtrl.result.dxNameB}}</span>
	    		<span ng-if="aCtrl.result.consistencyType === 'time' && aCtrl.result.type === 'constant'">Average</span>
	    		<span ng-if="aCtrl.result.consistencyType === 'time' && aCtrl.result.type != 'constant'">Forecast</span>
	    	</th>
	    	<th>
	    		<span ng-if="aCtrl.result.consistencyType === 'relation' && aCtrl.result.type === 'do'">Dropout rate (%)</span>
	    		<span ng-if="aCtrl.result.consistencyType === 'relation' && aCtrl.result.type != 'do'">Ratio</span>
	    		<span ng-if="aCtrl.result.consistencyType === 'time'">Ratio</span>
	    	</th>
	    	<th></th>
	    </tr>
	</thead>
	
	<tbody>
    	<tr ng-if="aCtrl.selectedObject.hasOwnProperty('name')">
            <td>{{aCtrl.selectedObject.name}}</td>
            <td class="valueCell">{{aCtrl.selectedObject.value}}</td>
            <td class="valueCell">{{aCtrl.selectedObject.refValue}}</td>
            <td class="valueCell">
	            <span ng-if="aCtrl.result.consistencyType === 'relation' && aCtrl.result.type === 'do'">
	            	{{aCtrl.dropoutRate(aCtrl.selectedObject.value, aCtrl.selectedObject.refValue)}}%
	            </span>
	            <span ng-if="aCtrl.result.type != 'do'">
	            	{{aCtrl.selectedObject.ratio}}
	            </span>
	        </td>
            <td>
            	<span class="dropdown" dropdown>
                  <a href class="dropdown-toggle" dropdown-toggle>
                          <span class="glyphicon glyphicon-th-list" style="color: black" aria-hidden="true"></span>
                        </a>
                  <ul class="dropdown-menu dropdown-menu-right">
                    <li><a href ng-click="aCtrl.sendMessage(aCtrl.selectedObject);">Contact</a></li>
                    <li><a href ng-click="aCtrl.drillDown(aCtrl.selectedObject);">Drill down</a></li>
                  </ul>
                  </span>
            </td>    
        </tr>
        <tr ng-if="!aCtrl.selectedObject.hasOwnProperty('name')">
        	<td colspan="5">Click on the graph or in the table see details.</td>
        </tr>
	</tbody>
</table>
</div>

<nvd3 options='aCtrl.chartSelected.options' data='aCtrl.chartSelected.data'></nvd3>

</div>